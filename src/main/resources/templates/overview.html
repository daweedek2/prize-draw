<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Losovací aplikace</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <style>
        /* Reveal overlay styles */
        .reveal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.55);
            display: none; align-items: center; justify-content: center;
            z-index: 9999; padding: 16px;
        }
        .reveal-overlay.open { display: flex; }
        .reveal-card {
            background: #fff; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.25);
            padding: 22px; width: 96vw; max-width: 520px; text-align: center; position: relative;
            border: 3px solid #ffb300;
        }
        .reveal-title { font-size: 18px; color: #666; margin: 0 0 8px; }
        .reveal-name {
            font-size: clamp(26px, 6.4vw, 36px); font-weight: 800; letter-spacing: 0.4px; margin: 6px 0 10px; color: #111;
        }
        .reveal-prize {
            font-size: 16px; color: #555; margin-top: 6px;
        }
        .reveal-spinner {
            width: 54px; height: 54px; border-radius: 50%; border: 5px solid #eee; border-top-color: #005bbb;
            margin: 12px auto 0; animation: spin 0.9s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<h1>Losování cen</h1>

<section>
    <h2>Vylosované položky</h2>
    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>Cena</th>
                <th>Výherce</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item : ${vysledky}">
                <td th:text="${item.cena}"></td>
                <td th:text="${item.clovek}"></td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section>
    <h2>Dostupné ceny</h2>
    <p th:if="${nextPrize != null}">
        Aktuální cena k losování: <strong th:text="${nextPrize}"></strong>
    </p>
    <p th:if="${nextPrize == null}">
        Všechny ceny jsou již vylosované. Losování je ukončeno.
    </p>
    <ul class="list-responsive" id="available-prizes">
        <li th:each="c : ${ceny}" th:text="${c.nazev}"></li>
    </ul>
</section>

<section>
    <h2>Lidé</h2>
    <ul class="list-responsive">
        <li th:each="l : ${lide}" th:text="${l.jmeno}"></li>
    </ul>
</section>

<section class="button-group-center">
    <form th:action="@{/losovat}" method="post" class="inline-form">
        <input type="hidden" name="previewPersonId" id="preview-person-id-available">
        <button type="submit" id="btn-draw"
                th:disabled="${nextPrize == null}"
                th:attr="aria-disabled=${nextPrize == null}">Losovat</button>
    </form>

    <form th:action="@{/losovat-ze-vsech}" method="post" class="inline-form">
        <input type="hidden" name="previewPersonId" id="preview-person-id-all">
        <button type="submit" id="btn-draw-all"
                th:disabled="${nextPrize == null}"
                th:attr="aria-disabled=${nextPrize == null}">Losovat ze všech</button>
    </form>
</section>

<section class="admin-nav">
    <a th:href="@{/admin/people}" class="button-link">
        <button type="button">Administrace lidí</button>
    </a>
    <a th:href="@{/admin/prizes}" class="button-link">
        <button type="button">Administrace cen</button>
    </a>
</section>

<!-- Párová data pro animaci odhalení -->
<ul id="eligible-without-pairs" style="display:none;">
    <li th:each="p : ${eligibleWithoutPrizePairs}" th:data-id="${p.id}" th:text="${p.name}"></li>
</ul>
<ul id="eligible-all-pairs" style="display:none;">
    <li th:each="p : ${eligibleAllPairs}" th:data-id="${p.id}" th:text="${p.name}"></li>
</ul>

<!-- Overlay pro odhalení vítěze -->
<div id="reveal-overlay" class="reveal-overlay" aria-hidden="true">
    <div class="reveal-card">
        <div class="reveal-title">Losujeme…</div>
        <div id="reveal-name" class="reveal-name">—</div>
        <div class="reveal-prize">Cena: <strong th:text="${nextPrize}">—</strong></div>
        <div class="reveal-spinner"></div>
    </div>
</div>

<script th:inline="javascript">
    (function(){
        const overlay = document.getElementById('reveal-overlay');
        const nameEl = document.getElementById('reveal-name');

        function readLabelsAndIdsFrom(elemId) {
            const items = Array.from(document.querySelectorAll('#' + elemId + ' li'));
            const labels = items.map(li => li.textContent.trim());
            const ids = items.map(li => Number(li.dataset.id));
            return { labels, ids };
        }

        const withoutPairs = readLabelsAndIdsFrom('eligible-without-pairs');
        const allPairs = readLabelsAndIdsFrom('eligible-all-pairs');

        async function fetchPreview(mode) {
            const res = await fetch(`/api/preview?mode=${encodeURIComponent(mode)}`, { method: 'GET' });
            if (!res.ok) throw new Error('Preview API failed');
            return await res.json(); // { personId, name, prizeName }
        }

        function shuffleReveal(labels, finalName, durationMs = 1200) {
            if (!labels || labels.length === 0) return;
            overlay.classList.add('open');
            const start = performance.now();
            function step(now) {
                const t = Math.min(1, (now - start) / durationMs);
                const idx = Math.floor(Math.random() * labels.length);
                nameEl.textContent = labels[idx];
                if (t < 1) {
                    requestAnimationFrame(step);
                } else {
                    nameEl.textContent = finalName || '—';
                    setTimeout(() => { /* krátká pauza před submitem */ }, 100);
                }
            }
            requestAnimationFrame(step);
        }

        function runServerDriven(mode, pairs, form, hiddenInputEl) {
            const { labels, ids } = pairs;
            if (!labels || labels.length === 0) { form.submit(); return; }

            fetchPreview(mode)
                .then(({ personId, name }) => {
                    shuffleReveal(labels, name);
                    // vyplň ID a odešli po krátké pauze (shoda s BE garantována)
                    hiddenInputEl.value = Number(personId) || '';
                    setTimeout(() => {
                        overlay.classList.remove('open');
                        form.submit();
                    }, 1400);
                })
                .catch(() => form.submit());
        }

        const drawForm = document.querySelector('form[action="/losovat"]');
        const drawAllForm = document.querySelector('form[action="/losovat-ze-vsech"]');
        const hiddenAvailable = document.getElementById('preview-person-id-available');
        const hiddenAll = document.getElementById('preview-person-id-all');

        const hasAvailablePrize = /*[[${nextPrize != null}]]*/ false;

        if (hasAvailablePrize && drawForm) {
            drawForm.addEventListener('submit', function(ev) {
                ev.preventDefault();
                runServerDriven('available', withoutPairs, this, hiddenAvailable);
            });
        }
        if (hasAvailablePrize && drawAllForm) {
            drawAllForm.addEventListener('submit', function(ev) {
                ev.preventDefault();
                runServerDriven('all', allPairs, this, hiddenAll);
            });
        }
    })();
</script>

</body>
</html>